<div class="segments-editor">
  <div class="editor-actions">
    <button type="button" (click)="addRich()" class="ds-btn ds-btn-primary">
      Añadir segmento texto/imagen
    </button>
    <button type="button" (click)="addCarousel()" class="ds-btn ds-btn-primary">
      Añadir carrusel
    </button>
  </div>

  <div class="segments-list">
    @for (seg of segments(); track seg.id) {
      <article class="segment-card">
        <div class="segment-header">
          <div class="segment-title">
            #{{ seg.order }} ·
            @if (seg.type === 'rich') {
              Texto/Imagen
            } @else if (seg.type === 'carousel') {
              Carrusel
            }
          </div>
          @if (editingId() === seg.id) {
            <div class="segment-actions">
              <button type="button" class="ds-btn ds-btn-primary" (click)="saveEdit()">
                Guardar
              </button>
              <button type="button" class="ds-btn ds-btn-secondary" (click)="discardEdit()">
                Descartar
              </button>
            </div>
          } @else {
            <div class="segment-actions">
              <button type="button" class="ds-btn ds-btn-secondary" (click)="moveUp(seg.id)">
                ↑
              </button>
              <button type="button" class="ds-btn ds-btn-secondary" (click)="moveDown(seg.id)">
                ↓
              </button>
              <button type="button" class="ds-btn ds-btn-secondary" (click)="startEdit(seg.id)">
                Editar
              </button>
              <button type="button" class="ds-btn ds-btn-danger" (click)="remove(seg.id)">
                Eliminar
              </button>
            </div>
          }
        </div>

        @if (editingId() === seg.id) {
          @if (editingDraft(); as draft) {
            <div class="segment-edit">
              @if (draft.type === 'rich') {
                <div class="rich-editor">
                  <div class="form-row">
                    <div class="ds-field">
                      <label class="ds-label">Posicionamiento</label>
                      <select
                        class="ds-select"
                        [value]="draft.imagePlacement ?? 'top'"
                        (change)="onRichPlacementChange(draft.id, $event)"
                      >
                        <option value="top">Arriba</option>
                        <option value="left">Izquierda</option>
                        <option value="right">Derecha</option>
                      </select>
                    </div>
                    <div class="ds-field">
                      <label class="ds-label">Ancho (%)</label>
                      <select
                        class="ds-select"
                        [value]="draft.imageWidth ?? 50"
                        (change)="onRichWidthChange(draft.id, $event)"
                      >
                        <option [value]="10">10</option>
                        <option [value]="25">25</option>
                        <option [value]="33">33</option>
                        <option [value]="50">50</option>
                        <option [value]="66">66</option>
                        <option [value]="75">75</option>
                        <option [value]="100">100</option>
                      </select>
                    </div>
                  </div>

                  <div class="image-section">
                    @if (draft.image; as image) {
                      <div class="image-preview" (click)="toggleRichPicker()">
                        <img [src]="image.url" alt="" class="preview-img" />
                        <div class="image-name">{{ fileName(image.url) }}</div>
                      </div>
                    } @else {
                      <button
                        type="button"
                        class="ds-btn ds-btn-secondary"
                        (click)="toggleRichPicker()"
                      >
                        Añadir imagen
                      </button>
                    }

                    @if (richPickerOpen()) {
                      <app-media-picker
                        [scopeType]="scopeType()"
                        [scopeId]="scopeId()"
                        [includeGlobal]="true"
                        [mode]="'single'"
                        (pick)="onRichMediaPicked($event); toggleRichPicker()"
                        (uploadSuccess)="onRichMediaPicked($event); toggleRichPicker()"
                        (error)="onMediaPickerError($event)"
                        (close)="toggleRichPicker()"
                      ></app-media-picker>
                    }

                    @if (draft.image) {
                      <button type="button" class="ds-btn ds-btn-danger" (click)="removeImage()">
                        Quitar imagen
                      </button>
                    }

                    @if (pickerError()) {
                      <div class="error-message">{{ pickerError() }}</div>
                    }
                  </div>

                  <div class="quill-section">
                    <span class="section-label">Texto</span>
                    <div class="quill-shell">
                      <quill-editor
                        #editor
                        class="quill-editor-block"
                        [modules]="modules"
                        [formControl]="quillControl"
                        theme="snow"
                      ></quill-editor>
                    </div>
                  </div>
                </div>
              }

              @if (draft.type === 'carousel') {
                <div class="carousel-editor">
                  <div class="form-row">
                    <div class="ds-field">
                      <label class="ds-label">Altura (px)</label>
                      <input
                        class="ds-input"
                        type="number"
                        min="1"
                        [value]="draft.height"
                        (input)="onCarouselHeightChange(draft.id, $event)"
                      />
                    </div>
                    <div class="ds-field">
                      <label class="ds-label">Imágenes visibles</label>
                      <select
                        class="ds-select"
                        [value]="draft.imagesPerView"
                        (change)="onCarouselImagesPerViewChange(draft.id, $event)"
                      >
                        <option [value]="1">1</option>
                        <option [value]="2">2</option>
                        <option [value]="3">3</option>
                        <option [value]="4">4</option>
                        <option [value]="5">5</option>
                        <option [value]="6">6</option>
                      </select>
                    </div>
                    <div class="ds-field">
                      <label class="ds-label">Retardo (s)</label>
                      <input
                        class="ds-input"
                        type="number"
                        min="0"
                        placeholder="0 desactiva el autoavance"
                        (input)="onCarouselDelayChange(draft.id, $event)"
                      />
                    </div>
                  </div>

                  <div class="carousel-images">
                    <button
                      type="button"
                      class="ds-btn ds-btn-secondary"
                      (click)="toggleCarouselPicker()"
                    >
                      Añadir imagen
                    </button>

                    @if (carouselPickerOpen()) {
                      <app-media-picker
                        [scopeType]="scopeType()"
                        [scopeId]="scopeId()"
                        [includeGlobal]="true"
                        [mode]="'multi'"
                        [infoMessage]="pickerInfo()"
                        (pick)="onCarouselMediaPicked($event)"
                        (uploadSuccess)="onCarouselMediaPicked($event)"
                        (error)="onMediaPickerError($event)"
                        (close)="toggleCarouselPicker()"
                      ></app-media-picker>
                    }

                    @if (draft.images.length) {
                      <div class="images-grid">
                        @for (img of draft.images; track $index) {
                          <div class="carousel-image-item">
                            <img [src]="img.url" alt="" class="carousel-img" />
                            <div class="image-item-footer">
                              <span class="image-item-name">{{ fileName(img.url) }}</span>
                              <button
                                type="button"
                                class="btn-remove"
                                (click)="removeCarouselImage($index)"
                              >
                                Eliminar
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="no-images">El carrusel no tiene imágenes.</div>
                    }

                    @if (pickerError()) {
                      <div class="error-message">{{ pickerError() }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        }

        @if (editingId() !== seg.id) {
          <div class="segment-preview">
            <app-content-renderer [content]="singleContent(seg)"></app-content-renderer>
          </div>
        }
      </article>
    }
  </div>

  <!-- Selector de enlaces internos -->
  @if (showLinkSelector()) {
    <app-link-selector
      (select)="onLinkSelected($event)"
      (cancel)="onLinkCanceled()"
    ></app-link-selector>
  }
</div>
