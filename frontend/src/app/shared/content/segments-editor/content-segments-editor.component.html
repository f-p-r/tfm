<div class="segments-editor">

  <div class="editor-actions">
    <button type="button" (click)="addBlock('1')" class="ds-btn-sm ds-btn-primary">
      + Bloque Contenido
    </button>
    <button type="button" (click)="addCarousel()" class="ds-btn-sm ds-btn-secondary">
      + Carrusel
    </button>
  </div>

  <div class="segments-list">
    @for (seg of segments(); track seg.id; let i = $index) {
    <article class="segment-card" [class.editing]="editingId() === seg.id">

      <div class="segment-header">
        <div class="segment-info">
          <span class="ds-badge ds-badge-active">#{{ seg.order }}</span>
          <span class="segment-type">
            {{ seg.type === 'columns' ? (seg.distribution === '1' ? 'Bloque Texto' : 'Multi-Columna') : 'Carrusel' }}
          </span>
        </div>
        <div class="segment-actions">
          <button type="button" (click)="moveSegment(i, -1)" [disabled]="i === 0" class="ds-btn-arrow"
            title="Subir">⬆</button>

          <button type="button" (click)="moveSegment(i, 1)" [disabled]="i === segments().length - 1"
            class="ds-btn-arrow" title="Bajar">⬇</button>

          @if (editingId() !== seg.id) {
          <button type="button" (click)="startEdit(seg.id)" class="ds-btn-sm ds-btn-secondary">Editar</button>
          <button type="button" (click)="deleteSegment(i)" class="ds-btn-sm ds-btn-danger">Borrar</button>
          }
        </div>
      </div>

      @if (editingId() !== seg.id) {
      <div class="segment-preview">
        <app-content-segments-preview [content]="{ schemaVersion: 1, segments: [seg] }" />
      </div>
      }

      @if (editingId() === seg.id && editingDraft(); as draft) {
      <div class="segment-edit-panel">

        @if (draft.type === 'columns') {
        <div class="controls-grid">

          <div class="ds-field">
            <div class="ds-label-with-help">
              <label class="ds-label">Distribución</label>
              <app-help-i helpKey="col_dist"></app-help-i>
            </div>
            <select class="ds-select"
                    helpHover [helpKey]="'col_dist'"
                    [ngModel]="draft.distribution"
                    (ngModelChange)="updateDistribution($event)">
              <option value="1">Ancho Completo</option>
              <optgroup label="2 Cols">
                <option value="1-1">50/50</option>
                <option value="2-1">66/33</option>
                <option value="1-2">33/66</option>
                <option value="1-3">25/75</option>
                <option value="3-1">75/25</option>
              </optgroup>
              <optgroup label="3 Cols">
                <option value="1-1-1">33/33/33</option>
                <option value="1-2-1">25/50/25</option>
                <option value="2-1-1">50/25/25</option>
                <option value="1-1-2">25/25/50</option>
              </optgroup>
              <optgroup label="4 Cols">
                <option value="1-1-1-1">25/25/25/25</option>
              </optgroup>
            </select>
          </div>

          <div class="ds-field">
            <div class="ds-label-with-help">
              <label class="ds-label">Padding</label>
              <app-help-i helpKey="col_padding"></app-help-i>
            </div>
            <select class="ds-select"
                    helpHover [helpKey]="'col_padding'"
                    [ngModel]="draft.verticalPadding"
                    (ngModelChange)="updateProperty('verticalPadding', $event)">
              <option value="normal">Normal</option>
              <option value="large">Amplio</option>
              <option value="small">Pequeño</option>
              <option value="none">Ninguno</option>
            </select>
          </div>

          <div class="ds-field">
            <div class="ds-label-with-help">
              <label class="ds-label">Fondo</label>
              <app-help-i helpKey="col_bg"></app-help-i>
            </div>
            <select class="ds-select"
                    helpHover [helpKey]="'col_bg'"
                    [ngModel]="draft.backgroundColor"
                    (ngModelChange)="updateProperty('backgroundColor', $event)">
              <option value="transparent">Transparente</option>
              <option value="brand-primary" style="background-color: #1B4F72; color: white;">Primary</option>
              <option value="brand-secondary" style="background-color: #F4CB42; color: #2C3E50;">Secondary</option>
              <option value="brand-accent" style="background-color: #48C9B0; color: white;">Accent</option>
              <option value="danger" style="background-color: #DC3545; color: white;">Danger</option>
              <option value="brand-primary-light" style="background-color: #C5D7E4; color: #2C3E50;">Primary Light</option>
              <option value="brand-secondary-light" style="background-color: #FDF3D7; color: #2C3E50;">Secondary Light</option>
              <option value="brand-accent-light" style="background-color: #D0F0E8; color: #2C3E50;">Accent Light</option>
              <option value="danger-light" style="background-color: #F8D7DA; color: #2C3E50;">Danger Light</option>
              <option value="neutral-dark" style="background-color: #2C3E50; color: white;">Neutral Dark</option>
              <option value="neutral-medium" style="background-color: #D5D8DC; color: #2C3E50;">Neutral Medium</option>
              <option value="neutral-light" style="background-color: #F7F9FA; color: #2C3E50;">Neutral Light</option>
            </select>
          </div>

          <div class="ds-field">
            <div class="ds-label-with-help">
              <label class="ds-label">Texto</label>
              <app-help-i helpKey="col_text_color"></app-help-i>
            </div>
            <select class="ds-select"
                    helpHover [helpKey]="'col_text_color'"
                    [ngModel]="draft.textColor"
                    (ngModelChange)="updateProperty('textColor', $event)">
              <option value="default">Default</option>
              <option value="brand">Azul</option>
              <option value="white">Blanco</option>
            </select>
          </div>

          <div class="ds-field">
            <div class="ds-label-with-help">
              <label class="ds-label">Ancho</label>
              <app-help-i helpKey="col_width"></app-help-i>
            </div>
            <select class="ds-select"
                    helpHover [helpKey]="'col_width'"
                    [ngModel]="draft.containerWidth"
                    (ngModelChange)="updateProperty('containerWidth', $event)">
              <option value="standard">Estándar</option>
              <option value="narrow">Lectura</option>
              <option value="full">Completo</option>
            </select>
          </div>

          <div class="ds-field ds-field-checkbox-grid">
            <div class="ds-label-with-help">
              <label class="ds-checkbox-label ds-label" helpHover [helpKey]="'col_fullwidth_bg'">
                <input type="checkbox"
                       [ngModel]="draft.fullWidthBackground"
                       (ngModelChange)="updateProperty('fullWidthBackground', $event)" />
                <span>Fondo a ancho completo</span>
              </label>
              <app-help-i helpKey="col_fullwidth_bg"></app-help-i>
            </div>
          </div>
        </div>

        <div
          class="preview-area"
          [ngClass]="{
            'ds-seg-wrapper-full': draft.fullWidthBackground,
            'ds-seg-text-default': draft.textColor === 'default',
            'ds-seg-text-brand': draft.textColor === 'brand',
            'ds-seg-text-white': draft.textColor === 'white'
          }"
          [class]="draft.fullWidthBackground && draft.backgroundColor ? 'bg-' + draft.backgroundColor : ''">
          <div
            class="ds-layout-grid"
            [attr.data-layout]="draft.distribution"
            [ngClass]="{
              '': draft.containerWidth === 'standard' || !draft.containerWidth,
              'ds-seg-width-narrow': draft.containerWidth === 'narrow',
              'ds-seg-width-full': draft.containerWidth === 'full',
              'ds-seg-pad-none': draft.verticalPadding === 'none',
              'ds-seg-pad-small': draft.verticalPadding === 'small',
              'ds-seg-pad-normal': draft.verticalPadding === 'normal',
              'ds-seg-pad-large': draft.verticalPadding === 'large'
            }"
            [class]="!draft.fullWidthBackground && draft.backgroundColor ? 'bg-' + draft.backgroundColor : ''">
            @for (col of draft.columns; track col.id; let idx = $index) {
            <div class="ds-layout-cell ds-user-content bg-white/50">
              @if (draft.distribution !== '1') { <div class="text-xs text-gray-400 text-center mb-1">COL {{idx+1}}</div>
              }

              <editor [init]="tinyConfig()" [(ngModel)]="col.contentHtml" placeholder="Escribe el contenido...">
              </editor>

            </div>
            }
          </div>
        </div>
        }

        @if (draft.type === 'carousel') {
          <div class="controls-grid">
            <div class="ds-field">
              <div class="ds-label-with-help"><label class="ds-label">Altura (px)</label></div>
              <input type="number" class="ds-input" [ngModel]="draft.height" (ngModelChange)="updateProperty('height', $event)">
            </div>
            <div class="ds-field">
              <div class="ds-label-with-help"><label class="ds-label">Imágenes/Vista</label></div>
              <select class="ds-select" [ngModel]="draft.imagesPerView" (ngModelChange)="updateProperty('imagesPerView', $event)">
                <option [value]="1">1</option>
                <option [value]="2">2</option>
                <option [value]="3">3</option>
                <option [value]="4">4</option>
                <option [value]="6">6</option>
              </select>
            </div>
            <div class="ds-field">
              <div class="ds-label-with-help"><label class="ds-label">Auto-play (seg)</label></div>
              <input type="number" class="ds-input" [ngModel]="draft.delaySeconds" (ngModelChange)="updateProperty('delaySeconds', $event)">
            </div>
          </div>

          <div class="my-4 border rounded p-3 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
              <h4 class="font-bold text-sm text-gray-700">Imágenes ({{draft.images.length}})</h4>
              <button type="button" class="ds-btn-sm ds-btn-primary" (click)="openCarouselImagePicker()">+ Añadir Imagen</button>
            </div>

            <div class="flex flex-wrap gap-2">
              @for (img of draft.images; track $index) {
                <div class="relative group w-20 h-20 border rounded overflow-hidden bg-white">
                  <img [src]="img.url" class="w-full h-full object-cover">
                  <button type="button" (click)="removeCarouselImage($index)"
                          class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity ds-btn-arrow">
                    ✕
                  </button>
                </div>
              }
              @if (draft.images.length === 0) {
                <div class="text-sm text-gray-500 italic p-2">No hay imágenes seleccionadas.</div>
              }
            </div>
          </div>

          <div class="preview-area border p-2 bg-white rounded">
            <div class="text-xs text-gray-400 mb-1">VISTA PREVIA:</div>
            <app-segment-carousel [segment]="draft"></app-segment-carousel>
          </div>
        }

        <div class="edit-footer">
          <button (click)="cancelEdit()" class="ds-btn">Cancelar</button>
          <button (click)="saveEdit()" class="ds-btn ds-btn-primary">Guardar</button>
        </div>
      </div>
      }
    </article>
    }
  </div>

  @if (showMediaPicker()) {
  <app-media-picker [scopeType]="scopeType()" [scopeId]="scopeId()" [includeGlobal]="true" [mode]="'single'"
    (pick)="onMediaSelected($event)" (close)="showMediaPicker.set(false)">
  </app-media-picker>
  }

</div>
