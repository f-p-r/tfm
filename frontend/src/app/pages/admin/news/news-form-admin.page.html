<!-- Admin Shell -->
<div class="ds-admin-shell">

  <!-- Sidebar -->
  <app-admin-sidebar-container />

  <!-- Main content -->
  <main class="ds-admin-main">

    @if (isEditMode() && isLoading()) {
      <div class="ds-admin-form ds-container">
        <div>
          <h1 class="h1 mb-4">{{ pageTitle() }}</h1>
          <app-admin-page-subtitle />
        </div>
        <p>Cargando noticia...</p>
      </div>
    } @else if (errorMessage() && isEditMode() && originalNews() === null) {
      <div class="ds-admin-form ds-container">
        <div>
          <h1 class="h1 mb-4">{{ pageTitle() }}</h1>
          <app-admin-page-subtitle />
        </div>
        <div class="ds-alert ds-alert-error">
          <p class="mb-4">{{ errorMessage() }}</p>
          <button class="ds-btn ds-btn-secondary" (click)="onCancel()">Volver</button>
        </div>
      </div>
    } @else {

      <div class="ds-admin-form ds-container">
        <div>
          <h1 class="h1 mb-4">{{ pageTitle() }}</h1>
          <app-admin-page-subtitle />
        </div>

        <!-- Sección de datos básicos (colapsable) -->
        <div class="form-section">
          <button type="button" class="ds-form-section-toggle" (click)="dataCollapsed.set(!dataCollapsed())">
            <span>Datos de la noticia</span>
            <span class="ds-form-section-toggle-icon">{{ dataCollapsed() ? '▸' : '▾' }}</span>
          </button>
          <div class="ds-form-section-body" [class.collapsed]="dataCollapsed()">
          <div class="space-y-4" style="margin: 0 4px 4px 4px;">
            <!-- Título + Slug + Publicada -->
            <div class="grid grid-cols-1 md:grid-cols-[1fr_300px_auto] gap-4">
              <div class="ds-field">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="title">Título</label>
                  <app-help-i helpKey="title"></app-help-i>
                </div>
                <input
                  type="text"
                  id="title"
                  class="ds-input"
                  helpHover
                  helpKey="title"
                  [(ngModel)]="title"
                  placeholder="Título de la noticia"
                  maxlength="40"
                  [disabled]="isSaving()"
                />
                @if (validationErrors()['title']) {
                  <div>
                    @for (error of validationErrors()['title']; track error) {
                      <p class="ds-error">{{ error }}</p>
                    }
                  </div>
                }
              </div>

              <div class="ds-field">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="slug">Slug (URL)</label>
                  <app-help-i helpKey="slug"></app-help-i>
                </div>
                <input
                  type="text"
                  id="slug"
                  class="ds-input"
                  [class.ds-control-error]="validationErrors()['slug']"
                  helpHover
                  helpKey="slug"
                  [(ngModel)]="slug"
                  placeholder="slug-noticia"
                  maxlength="25"
                  [disabled]="isSaving()"
                />
                @if (validationErrors()['slug']) {
                  <div>
                    @for (error of validationErrors()['slug']; track error) {
                      <p class="ds-error">{{ error }}</p>
                    }
                  </div>
                }
              </div>

              <div class="ds-field ds-field-checkbox-grid">
                <div class="ds-label-with-help">
                  <label class="ds-checkbox-label ds-label">
                    <input type="checkbox" helpHover helpKey="published" [(ngModel)]="published" [disabled]="isSaving()" />
                    <span>Publicada</span>
                  </label>
                  <app-help-i helpKey="published"></app-help-i>
                </div>
              </div>
            </div>

            <!-- Texto introductorio (obligatorio) -->
            <div class="ds-field">
              <div class="ds-label-with-help">
                <label class="ds-label" for="text">Texto introductorio</label>
                <app-help-i helpKey="text"></app-help-i>
              </div>
              <textarea
                id="text"
                class="ds-textarea"
                helpHover
                helpKey="text"
                [(ngModel)]="text"
                placeholder="Resumen o entradilla de la noticia"
                rows="2"
                [disabled]="isSaving()"
              ></textarea>
              @if (validationErrors()['text']) {
                <div>
                  @for (error of validationErrors()['text']; track error) {
                    <p class="ds-error">{{ error }}</p>
                  }
                </div>
              }
            </div>

            <!-- Selector de juego (solo scopeType=2 ASSOCIATION) -->
            @if (scopeType() === 2) {
              <div class="ds-field" style="width: fit-content;">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="gameId">Juego</label>
                  <app-help-i helpKey="gameId"></app-help-i>
                </div>
                <select
                  id="gameId"
                  class="ds-input"
                  style="width: auto;"
                  helpHover
                  helpKey="gameId"
                  [(ngModel)]="gameId"
                  [disabled]="isSaving()"
                >
                  <option [ngValue]="null">— Sin juego —</option>
                  @for (game of associationGames(); track game.id) {
                    <option [ngValue]="game.id">{{ game.name }}</option>
                  }
                </select>
              </div>
              }
            </div><!-- /space-y-4 -->
          </div><!-- /ds-form-section-body -->
        </div>

        <!-- Sección de contenido (colapsable) -->
        <div class="form-section">
          <button type="button" class="ds-form-section-toggle" (click)="contentCollapsed.set(!contentCollapsed())">
            <span>Contenido</span>
            <span class="ds-form-section-toggle-icon">{{ contentCollapsed() ? '▸' : '▾' }}</span>
          </button>

          <!-- Clases CSS: siempre visible, justo bajo el título -->
          <div class="ds-field" style="margin-bottom: 0.75rem;">
            <div class="ds-label-with-help">
              <label class="ds-label" for="classNames">Clases CSS del contenido (avanzado)</label>
              <app-help-i helpKey="classNames"></app-help-i>
            </div>
            <input
              type="text"
              id="classNames"
              class="ds-input"
              helpHover
              helpKey="classNames"
              [(ngModel)]="classNames"
              placeholder="ds-clase-1 ds-clase-2"
              [disabled]="isSaving()"
            />
          </div>

          <div class="ds-form-section-body" [class.collapsed]="contentCollapsed()">
            <div class="space-y-4">

              <!-- Editor de contenido (opcional) -->
              <div class="editor-section">
                <app-content-segments-editor
                  [initialContent]="editorInitialContent()"
                  [scopeType]="scopeType()"
                  [scopeId]="scopeId() ?? 0"
                  (contentChange)="onContentChange($event)"
                  (editingStateChange)="onEditingStateChange($event)"
                />
                @if (content().segments.length === 0) {
                  <p class="ds-help text-muted" style="display: block; margin-top: 0.5rem;">
                    El contenido enriquecido es opcional para las noticias.
                  </p>
                }
              </div>

            </div>
          </div><!-- /ds-form-section-body -->
        </div>

      </div>

      <!-- Acciones (sticky, hijo directo de ds-admin-main) -->
      <div class="ds-actions-section ds-container">
        @if (errorMessage()) {
          <div class="ds-alert ds-alert-error">{{ errorMessage() }}</div>
        }

        <div class="ds-actions-buttons">
          <button
            class="ds-btn"
            [class.ds-btn-danger]="!isEditingSegment() && !isSaving()"
            [class.ds-btn-disabled]="isEditingSegment() || isSaving()"
            (click)="onCancel()"
            [disabled]="isEditingSegment() || isSaving()"
          >
            Cancelar
          </button>
          <button
            class="ds-btn"
            [class.ds-btn-secondary]="!isEditingSegment() && !isSaving()"
            [class.ds-btn-disabled]="isEditingSegment() || isSaving()"
            (click)="openPreview()"
            [disabled]="isEditingSegment() || isSaving()"
          >
            Vista previa
          </button>
          <button
            class="ds-btn"
            [class.ds-btn-primary]="!isSubmitDisabled()"
            [class.ds-btn-disabled]="isSubmitDisabled()"
            (click)="onSubmit()"
            [disabled]="isSubmitDisabled()"
          >
            {{ isSaving() ? (isEditMode() ? 'Guardando...' : 'Creando...') : (isEditMode() ? 'Guardar cambios' : 'Crear noticia') }}
          </button>
        </div>
      </div>

    }
  </main>

</div>
