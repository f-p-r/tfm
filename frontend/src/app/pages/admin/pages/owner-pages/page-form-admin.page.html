<!-- Admin Shell -->
<div class="ds-admin-shell">

  <!-- Sidebar -->
  <app-admin-sidebar-container />

  <!-- Main content -->
  <main class="ds-admin-main ds-container">
    <div class="page-form-admin">
      <div>
        <h1 class="page-main-title">{{ pageTitle() }}</h1>
        <app-admin-page-subtitle />
      </div>
      <!-- Loading state (solo en modo edición) -->
      @if (isEditMode() && isLoading()) {
        <p>Cargando página...</p>
      } @else if (errorMessage() && (isEditMode() || ownerType() === null)) {
        <div class="error-message">
          <p>{{ errorMessage() }}</p>
          <button class="ds-btn ds-btn-secondary" (click)="onCancel()">Volver</button>
        </div>
      } @else {
        <!-- Form section -->
        <div class="form-section">
          <button class="form-section-toggle" type="button" (click)="dataCollapsed.set(!dataCollapsed())">
            <span>Datos de la página</span>
            <span class="form-section-toggle-icon" [style.transform]="dataCollapsed() ? 'rotate(-90deg)' : ''">▾</span>
          </button>

          <div class="form-section-body" [class.collapsed]="dataCollapsed()">
          <div class="space-y-4" style="margin: 0 4px 4px 4px">
            <div class="grid grid-cols-1 md:grid-cols-[1fr_300px] gap-4">
              <div class="ds-field">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="title">Título</label>
                  <app-help-i helpKey="title"></app-help-i>
                </div>
                <input
                  type="text"
                  id="title"
                  class="ds-input"
                  helpHover
                  helpKey="title"
                  [(ngModel)]="title"
                  placeholder="Título de la página"
                  [disabled]="isSaving()"
                />
              </div>

              <div class="ds-field">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="slug">Slug (URL)</label>
                  <app-help-i helpKey="slug"></app-help-i>
                </div>
                <input
                  type="text"
                  id="slug"
                  class="ds-input"
                  [class.ds-control-error]="validationErrors()['slug']"
                  helpHover
                  helpKey="slug"
                  [(ngModel)]="slug"
                  placeholder="slug-pagina"
                  maxlength="25"
                  [disabled]="isSaving()"
                />
                @if (validationErrors()['slug']) {
                  <div class="error-field">
                    @for (error of validationErrors()['slug']; track error) {
                      <p class="ds-error">{{ error }}</p>
                    }
                  </div>
                }
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-4">
              <div class="ds-field">
                <div class="ds-label-with-help">
                  <label class="ds-label" for="classNames">Clases CSS (avanzado)</label>
                  <app-help-i helpKey="classNames"></app-help-i>
                </div>
                <input
                  type="text"
                  id="classNames"
                  class="ds-input"
                  helpHover
                  helpKey="classNames"
                  [(ngModel)]="classNames"
                  placeholder="ds-clase-1 ds-clase-2"
                  [disabled]="isSaving()"
                />
              </div>

              <div class="ds-field ds-field-checkbox-grid">
                <div class="ds-label-with-help">
                  <label class="ds-checkbox-label ds-label" helpHover helpKey="published">
                    <input type="checkbox" [(ngModel)]="published" [disabled]="isSaving()" />
                    <span>Página publicada</span>
                  </label>
                  <app-help-i helpKey="published"></app-help-i>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Editor section -->
        <div class="editor-section">
          <button class="form-section-toggle" type="button" (click)="contentCollapsed.set(!contentCollapsed())">
            <span>Contenido</span>
            <span class="form-section-toggle-icon" [style.transform]="contentCollapsed() ? 'rotate(-90deg)' : ''">▾</span>
          </button>

          <div class="form-section-body" [class.collapsed]="contentCollapsed()">
          <div>
            <app-content-segments-editor
              [initialContent]="editorInitialContent()"
              [scopeType]="+(ownerType()||0)"
              [scopeId]="ownerId() ?? 0"
              (contentChange)="onContentChange($event)"
              (editingStateChange)="onEditingStateChange($event)"
            />
            @if (content().segments.length === 0) {
              <p class="ds-help text-muted" style="display: block; margin-top: 0.5rem;">
                * La página debe tener al menos un segmento de contenido
              </p>
            }
          </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
          @if (errorMessage()) {
            <div class="error-inline">{{ errorMessage() }}</div>
          }

          <div class="actions-buttons">
            <button
              class="ds-btn"
              [class.ds-btn-danger]="!isEditingSegment() && !isSaving()"
              [class.ds-btn-disabled]="isEditingSegment() || isSaving()"
              (click)="onCancel()"
              [disabled]="isEditingSegment() || isSaving()"
            >
              Cancelar
            </button>
            <button
              class="ds-btn"
              [class.ds-btn-secondary]="!isEditingSegment() && !isSaving()"
              [class.ds-btn-disabled]="isEditingSegment() || isSaving()"
              (click)="openPreview()"
              [disabled]="isEditingSegment() || isSaving()"
            >
              Vista previa
            </button>
            <button
              class="ds-btn"
              [class.ds-btn-primary]="!isSubmitDisabled()"
              [class.ds-btn-disabled]="isSubmitDisabled()"
              (click)="onSubmit()"
              [disabled]="isSubmitDisabled()"
            >
              {{ isSaving() ? (isEditMode() ? 'Guardando...' : 'Creando...') : (isEditMode() ? 'Guardar cambios' : 'Crear página') }}
            </button>
          </div>
        </div>
      }
    </div>
  </main>

</div>
