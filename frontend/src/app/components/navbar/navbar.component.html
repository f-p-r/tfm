<ng-template #gamesSelector let-id="id" let-cssClass="cssClass" let-onChange="onChange">
  <label class="sr-only" [attr.for]="id">Seleccionar juego</label>
  <select
    [id]="id"
    [value]="gamesStore.selectedGameId() ?? ''"
    (change)="onChange($event)"
    [class]="cssClass"
  >
    <option value="" [selected]="!gamesStore.selectedGameId()">Todos los juegos</option>
    @for (g of gamesStore.sortedGames(); track g.id) {
      <option [value]="g.id" [selected]="gamesStore.selectedGameId() === g.id">{{ g.name }}</option>
    }
  </select>
</ng-template>

<ng-template #navItemsList let-cssClass="cssClass" let-onNavigate="onNavigate">
  @for (item of navItems(); track item.label) {
    @if (!item.condition || item.condition()) {
      @if (item.type === 'link') {
        <a [routerLink]="item.route" [class]="cssClass" (click)="onNavigate()">{{ item.label }}</a>
      } @else {
        <button type="button" [class]="cssClass" [class.text-left]="cssClass === 'ds-nav-mobile-link'" (click)="item.onClick?.(); onNavigate()" [attr.aria-label]="item.label === '?' ? 'Ayuda' : undefined">{{ item.label }}</button>
      }
    }
  }
</ng-template>

<ng-template #adminMobileList>
  @if (adminActions(); as actions) {
    @for (action of actions; track action.label) {
      @if (action.isVisible) {
        <a [routerLink]="action.route" class="ds-nav-mobile-link text-brand-primary font-medium" (click)="closeMobileMenu()">
          {{ action.label }}
        </a>
      }
    }
  }
</ng-template>

<nav class="ds-nav" aria-label="Navegación principal">
  <div class="ds-nav-inner">
    <a routerLink="/" class="ds-nav-brand">Naipeando</a>

    @if (isAdmin()) {
      <span class="ds-nav-link font-semibold">{{ displayName }}</span>
    }

    <div class="ds-nav-links">
      @if (!isAdmin()) {
        <ng-container *ngTemplateOutlet="gamesSelector; context: {id: 'desktop-games', cssClass: 'ds-nav-link', onChange: onDesktopGameChange.bind(this)}"></ng-container>
      }

      <ng-container *ngTemplateOutlet="navItemsList; context: {cssClass: 'ds-nav-link', onNavigate: noop.bind(this)}"></ng-container>

      @if (!isAdmin()) {
        @if (adminActions(); as actions) {
          @if (actions.length > 1) {
            <div class="ds-menu relative inline-block">
              <button
                type="button"
                class="ds-nav-link flex items-center gap-1 font-medium text-brand-primary"
                [attr.aria-expanded]="adminMenuOpen()"
                (click)="toggleAdminMenu()"
              >
                Administración
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </button>

              @if (adminMenuOpen()) {
                <div class="ds-menu-panel absolute right-0 mt-2 w-48 bg-white border border-neutral-medium rounded-lg shadow-lg z-50">
                  <div class="ds-menu-list p-1">
                    @for (action of actions; track action.label) {
                      @if (action.isVisible) {
                        <a
                          [routerLink]="action.route"
                          class="ds-menu-item block px-4 py-2 text-sm text-neutral-dark hover:bg-neutral-light rounded"
                          (click)="closeAdminMenu()"
                        >
                          {{ action.label }}
                        </a>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          }
          @else if (actions.length === 1 && actions[0].isVisible) {
            <a [routerLink]="actions[0].route" class="ds-nav-link font-medium text-brand-primary">
              {{ actions[0].label }}
            </a>
          }
        }
      }
    </div>

    <div class="ds-nav-actions">
      <app-user-menu variant="desktop"></app-user-menu>

      <button
        type="button"
        class="ds-nav-toggle"
        aria-label="Menú"
        [attr.aria-expanded]="mobileMenuOpen()"
        (click)="toggleMobileMenu()"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  @if (mobileMenuOpen()) {
    <div class="ds-nav-mobile">
      <div class="ds-nav-mobile-list">
        @if (!isAdmin()) {
          <div class="border-b border-neutral-medium">
            <ng-container *ngTemplateOutlet="gamesSelector; context: {id: 'mobile-games-select', cssClass: 'ds-nav-mobile-link w-full border-0', onChange: onMobileGameChange.bind(this)}"></ng-container>
          </div>
        }

        <ng-container *ngTemplateOutlet="navItemsList; context: {cssClass: 'ds-nav-mobile-link', onNavigate: closeMobileMenu.bind(this)}"></ng-container>

        @if (!isAdmin()) {
          <ng-container *ngTemplateOutlet="adminMobileList"></ng-container>
        }
      </div>
    </div>
  }
</nav>

<app-help-panel [isOpen]="helpOpen()" (close)="closeHelp()" />
