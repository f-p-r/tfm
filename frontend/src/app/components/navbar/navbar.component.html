<ng-template #gamesSelector let-id="id" let-cssClass="cssClass" let-onChange="onChange">
  <label class="sr-only" [attr.for]="id">Seleccionar juego</label>
  <select
    [id]="id"
    [value]="gamesStore.selectedGameId() ?? ''"
    (change)="onChange($event)"
    [class]="cssClass"
  >
    <option value="" [selected]="!gamesStore.selectedGameId()">Todos los juegos</option>
    @for (g of gamesStore.sortedGames(); track g.id) {
      <option [value]="g.id" [selected]="gamesStore.selectedGameId() === g.id">{{ g.name }}</option>
    }
  </select>
</ng-template>

<ng-template #navItemsList let-cssClass="cssClass" let-onNavigate="onNavigate">
  @for (item of navItems(); track item.label) {
    @if (!item.condition || item.condition()) {
      @if (item.type === 'link') {
        <a [routerLink]="item.route" [class]="cssClass" (click)="onNavigate()">{{ item.label }}</a>
      } @else {
        <button
          type="button"
          [class]="cssClass"
          [class.text-left]="cssClass === 'ds-nav-mobile-link'"
          (click)="item.onClick?.(); onNavigate()"
          [attr.aria-label]="item.label === '?' ? 'Ayuda' : undefined"
          [attr.title]="item.label === '?' ? 'Ayuda' : undefined"
        >
          @if (item.label === '?') {
            @if (cssClass === 'ds-nav-mobile-link') {
              <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">help</span> Ayuda
            } @else {
              <span class="material-symbols-outlined" style="font-size: 2em; font-weight: 700; vertical-align: middle;">help</span>
            }
          } @else {
            {{ item.label }}
          }
        </button>
      }
    }
  }
</ng-template>

<ng-template #adminMobileList>
  @if (adminActions(); as actions) {
    @for (action of actions; track action.label) {
      @if (action.isVisible) {
        <a [routerLink]="action.route" class="ds-nav-mobile-link text-brand-primary font-medium" (click)="closeMobileMenu()">
          {{ action.label }}
        </a>
      }
    }
  }
</ng-template>

<nav class="ds-nav" aria-label="Navegación principal">
  <div class="ds-nav-inner">
    <a routerLink="/" class="ds-nav-brand">Naipeando</a>

    @if (isAdmin()) {
      <span class="ds-nav-link font-semibold hidden md:inline">{{ displayName }}</span>
    }

    <div class="ds-nav-links">
      @if (!isAdmin()) {
        <!-- Selector de juegos: solo si NO estamos en scope de asociación -->
        @if (!isAssociationScope()) {
          <ng-container *ngTemplateOutlet="gamesSelector; context: {id: 'desktop-games', cssClass: 'ds-nav-link', onChange: onDesktopGameChange.bind(this)}"></ng-container>
        }

        <!-- Dropdown de asociación: solo si estamos en scope de asociación -->
        @if (isAssociationScope() && associationShortname()) {
          <div class="ds-menu relative hidden md:inline-block">
            <button
              type="button"
              class="ds-nav-link flex items-center gap-1 font-semibold"
              [attr.aria-expanded]="associationMenuOpen()"
              (click)="toggleAssociationMenu()"
            >
              {{ associationShortname() }}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>

            @if (associationMenuOpen()) {
              <div class="ds-menu-panel absolute right-0 mt-2 w-56 bg-white border border-neutral-medium rounded-lg shadow-lg z-50">
                <div class="ds-menu-list p-1">
                  <a
                    [routerLink]="['/asociaciones', associationSlug(), 'socios']"
                    class="ds-menu-item block px-4 py-2 text-sm text-neutral-dark hover:bg-neutral-light rounded"
                    (click)="closeAssociationMenu()"
                  >
                    <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">group</span> Socios / Admisión
                  </a>
                  <a
                    [routerLink]="['/asociaciones', associationSlug(), 'contacto']"
                    class="ds-menu-item block px-4 py-2 text-sm text-neutral-dark hover:bg-neutral-light rounded"
                    (click)="closeAssociationMenu()"
                  >
                    <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">mail</span> Contacto
                  </a>
                  <div class="border-t border-neutral-medium my-1"></div>
                  <a
                    routerLink="/asociaciones"
                    class="ds-menu-item block px-4 py-2 text-sm text-neutral-dark hover:bg-neutral-light rounded"
                    (click)="closeAssociationMenu()"
                  >
                    <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">exit_to_app</span> Volver a Asociaciones
                  </a>
                </div>
              </div>
            }
          </div>
        }
      }

      <ng-container *ngTemplateOutlet="navItemsList; context: {cssClass: 'ds-nav-link', onNavigate: noop.bind(this)}"></ng-container>

      @if (!isAdmin()) {
        @if (adminActions(); as actions) {
          @if (actions.length > 1) {
            <div class="ds-menu relative inline-block">
              <button
                type="button"
                class="ds-nav-link flex items-center gap-1 font-medium text-brand-primary"
                [attr.aria-expanded]="adminMenuOpen()"
                (click)="toggleAdminMenu()"
              >
                Administración
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </button>

              @if (adminMenuOpen()) {
                <div class="ds-menu-panel absolute right-0 mt-2 w-48 bg-white border border-neutral-medium rounded-lg shadow-lg z-50">
                  <div class="ds-menu-list p-1">
                    @for (action of actions; track action.label) {
                      @if (action.isVisible) {
                        <a
                          [routerLink]="action.route"
                          class="ds-menu-item block px-4 py-2 text-sm text-neutral-dark hover:bg-neutral-light rounded"
                          (click)="closeAdminMenu()"
                        >
                          {{ action.label }}
                        </a>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          }
          @else if (actions.length === 1 && actions[0].isVisible) {
            <a [routerLink]="actions[0].route" class="ds-nav-link font-medium text-brand-primary">
              {{ actions[0].label }}
            </a>
          }
        }

        <button
          type="button"
          class="ds-nav-link"
          (click)="openHelp()"
          aria-label="Ayuda"
          title="Ayuda"
        >
          <span class="material-symbols-outlined" style="font-size: 2em; font-weight: 700; vertical-align: middle;">help</span>
        </button>
      }
    </div>

    <div class="ds-nav-actions">
      <app-user-menu variant="desktop"></app-user-menu>

      <button
        type="button"
        class="ds-nav-toggle"
        aria-label="Menú"
        [attr.aria-expanded]="mobileMenuOpen()"
        (click)="toggleMobileMenu()"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  @if (mobileMenuOpen()) {
    <div class="ds-nav-mobile">
      <div class="ds-nav-mobile-list">
        @if (!isAdmin()) {
          <!-- Selector de juegos móvil: solo si NO estamos en scope de asociación -->
          @if (!isAssociationScope()) {
            <div class="border-b border-neutral-medium">
              <ng-container *ngTemplateOutlet="gamesSelector; context: {id: 'mobile-games-select', cssClass: 'ds-nav-mobile-link w-full border-0', onChange: onMobileGameChange.bind(this)}"></ng-container>
            </div>
          }

          <!-- Menú de asociación móvil: solo si estamos en scope de asociación -->
          @if (isAssociationScope() && associationShortname()) {
            <div class="border-b border-neutral-medium pb-2">
              <div class="px-4 py-2 text-xs font-semibold text-neutral-medium uppercase tracking-wider">
                {{ associationShortname() }}
              </div>
              <a
                [routerLink]="['/asociaciones', associationSlug(), 'socios']"
                class="ds-nav-mobile-link"
                (click)="closeMobileMenu()"
              >
                <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">group</span> Socios
              </a>
              <a
                [routerLink]="['/asociaciones', associationSlug(), 'contacto']"
                class="ds-nav-mobile-link"
                (click)="closeMobileMenu()"
              >
                <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">mail</span> Contacto
              </a>
              <a
                routerLink="/asociaciones"
                class="ds-nav-mobile-link"
                (click)="closeMobileMenu()"
              >
                <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">exit_to_app</span> Volver a Asociaciones
              </a>
            </div>
          }
        }

        <ng-container *ngTemplateOutlet="navItemsList; context: {cssClass: 'ds-nav-mobile-link', onNavigate: closeMobileMenu.bind(this)}"></ng-container>

        @if (!isAdmin()) {
          <ng-container *ngTemplateOutlet="adminMobileList"></ng-container>

          <button
            type="button"
            class="ds-nav-mobile-link text-left"
            (click)="openHelp(); closeMobileMenu()"
            aria-label="Ayuda"
          >
            <span class="material-symbols-outlined inline-block align-text-bottom mr-1" style="font-size: 1.2em;">help</span> Ayuda
          </button>
        }
      </div>
    </div>
  }
</nav>

<app-help-panel [isOpen]="helpOpen()" (close)="closeHelp()" />
